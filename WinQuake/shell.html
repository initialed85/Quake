<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <title>Quake</title>
    <script language="javascript">
      const onLoadOrResize = () => {
        const canvas = document.getElementById("canvas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      };

      const onLoad = () => {
        onLoadOrResize();
      };

      const onResize = () => {
        onLoadOrResize();
      };
    </script>
  </head>
  <body onload="javascript: onLoad();" onresize="javascript: onResize();" style="padding: 0px; margin: 0px">
    <div class="emscripten_border" style="padding: 0px; margin: 0px">
      <canvas
        class="emscripten"
        id="canvas"
        oncontextmenu="event.preventDefault()"
        tabindex="-1"
        style="margin: 0px; padding: 0px"
      ></canvas>
    </div>
    <script>
      const canvasElement = document.getElementById("canvas");

      canvasElement.addEventListener("webglcontextlost", (e) => {
        alert("WebGL context lost. You will need to reload the page."), e.preventDefault();
      });

      //
      // work out which resolution to ask for
      //

      const desiredAspectRatio = 320.0 / 200.0;

      const windowW = window.innerWidth; // e.g. 640
      const windowH = window.innerHeight; // e.g. 400

      const heightFromWidth = windowW / desiredAspectRatio; // e.g. 640 / 1.6 = 400
      const widthFromHeight = windowH * desiredAspectRatio; // e.g. 400 * 1.6 = 640

      let width, height;

      if (heightFromWidth < windowH) {
        width = windowW;
        height = heightFromWidth;
      } else {
        width = widthFromHeight;
        height = windowH;
      }

      width = Math.round(width);
      height = Math.round(height);

      const currentAspectRatio = width / height;

      console.log(
        `width: ${width}, height: ${height}, desiredAspectRatio: ${desiredAspectRatio}, currentAspectRatio: ${currentAspectRatio}`
      );

      //
      // set / recall the clientId (fake IP address)
      //

      let clientId = sessionStorage.getItem("clientId");

      while (
        !clientId ||
        typeof clientId !== "string" ||
        clientId.split(".").length !== 4 ||
        clientId === "255.255.255.255" ||
        clientId.split(".")[0] === "0" ||
        clientId.split(".")[0] === "255"
      ) {
        clientId = crypto.getRandomValues(new Uint8Array(4)).join(".");
      }

      sessionStorage.setItem("clientId", clientId);

      console.log(`set clientId: ${clientId} in sessionStorage`);

      //
      // set / recall the player colours
      //

      let color = sessionStorage.getItem("color");

      if (!color || typeof color !== "string" || color.split(" ").length !== 2) {
        while (!color) {
          color = `${Math.floor(Math.random() * 16)} ${Math.floor(Math.random() * 16)}`;
        }

        sessionStorage.setItem("color", color);

        console.log(`set color: ${color} in sessionStorage`);
      } else {
        console.log(`remembered color: ${color} from sessionStorage`);
      }
      let arguments = [];

      URL.parse(window.location.href.replaceAll("+", "%2b"))?.searchParams?.forEach((v, k) => {
        arguments.push(k);
        arguments.push(v);
      });

      if (!arguments.includes("-width")) {
        arguments.push("-width", width);
      }

      if (!arguments.includes("-height")) {
        arguments.push("-height", height);
      }

      arguments = arguments.filter((x) => x !== "clientId");
      arguments.push("-clientid", clientId);

      arguments = arguments.filter((x) => x !== "hostname");
      arguments.push("+hostname", "ws" + clientId.replaceAll(".", ""));

      arguments = arguments.filter((x) => x !== "name");
      arguments.push("+name", "ws" + clientId.replaceAll(".", ""));

      arguments = arguments.filter((x) => x !== "color");
      arguments.push("+color", color);

      arguments = arguments.map((x) => x.toString());

      console.log(`arguments: ${arguments}`);

      var Module = {
        print(...e) {
          console.log(...e);
        },
        printErr(...e) {
          console.warn(...e);
        },
        canvas: canvasElement,
        arguments: arguments,
      };
    </script>

    {{{ SCRIPT }}}
  </body>
</html>
